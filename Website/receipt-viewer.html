<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Beacon - Receipt Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'beacon': {
                            50: '#fef7f0',
                            100: '#fdeee1',
                            200: '#fad9c2',
                            300: '#f6be98',
                            400: '#f09c6c',
                            500: '#ea7c47',
                            600: '#b15e39',
                            700: '#944d2f',
                            800: '#7a3f28',
                            900: '#55250d'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --beacon-accent: #b15e39;
            --beacon-deep: #55250d;
        }
        a { text-decoration: none; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
    <!-- Header matching portal design -->
    <header class="border-b bg-white">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <a href="/portal/" class="flex items-center gap-2 font-semibold">
                    <img src="/images/Icon.webp" alt="Project Beacon" class="w-8 h-8" />
                    <span class="text-slate-400">Portal</span>
                </a>
                
                <!-- Navigation breadcrumb -->
                <nav class="flex items-center gap-2 text-sm text-slate-600">
                    <a href="/portal/" class="hover:text-slate-900">Portal</a>
                    <span>›</span>
                    <a href="/portal/executions" class="hover:text-slate-900">Executions</a>
                    <span>›</span>
                    <span class="text-beacon-600 font-medium">Receipt Viewer</span>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        <div class="space-y-6">
            <!-- Page header -->
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-semibold text-slate-900">Receipt Viewer</h1>
                    <p class="text-slate-600 mt-1">View detailed execution receipts with cryptographic provenance</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadLatestReceipts()" class="px-4 py-2 bg-beacon-600 text-white rounded-md hover:bg-beacon-700 transition-colors">
                        Load Latest
                    </button>
                    <button onclick="loadSpecificReceipt()" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50 transition-colors">
                        Load Specific
                    </button>
                </div>
            </div>

            <!-- Receipts container -->
            <div id="receipts-container" class="space-y-4"></div>
        </div>
    </main>

    <!-- Footer matching portal design -->
    <footer class="border-t bg-white mt-12">
        <div class="max-w-6xl mx-auto px-4 py-3 text-xs text-slate-500 flex items-center justify-center">
            <span>Project Beacon Receipt Viewer</span>
        </div>
    </footer>

    <script>
        // Use production API endpoint
        const RUNNER_API = 'https://beacon-runner-change-me.fly.dev';

        async function loadLatestReceipts() {
            const container = document.getElementById('receipts-container');
            container.innerHTML = `
                <div class="bg-white border rounded-lg p-6 text-center">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-beacon-600 border-t-transparent rounded-full"></div>
                    <p class="mt-2 text-slate-600">Loading execution receipts...</p>
                </div>
            `;

            try {
                // Fetch actual executions from the API
                const response = await fetch(`${RUNNER_API}/api/v1/executions?limit=10`);
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const executions = await response.json();
                
                if (!Array.isArray(executions) || executions.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white border rounded-lg p-6 text-center">
                            <p class="text-slate-500">No execution receipts found.</p>
                        </div>
                    `;
                    return;
                }

                // Fetch receipt data for each execution
                const receiptsWithData = await Promise.all(
                    executions.slice(0, 5).map(async (execution) => {
                        try {
                            const receiptResponse = await fetch(`${RUNNER_API}/api/v1/executions/${execution.id}/receipt`);
                            if (receiptResponse.ok) {
                                const receiptData = await receiptResponse.json();
                                return { ...execution, receipt_data: receiptData };
                            }
                        } catch (e) {
                            console.warn(`Failed to load receipt for execution ${execution.id}:`, e);
                        }
                        return execution;
                    })
                );

                displayReceipts(receiptsWithData);
            } catch (error) {
                console.error('Error loading receipts:', error);
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 text-red-800">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">Error loading receipts</span>
                        </div>
                        <p class="mt-1 text-red-700 text-sm">${error.message}</p>
                        <button onclick="loadLatestReceipts()" class="mt-3 px-3 py-1 bg-red-100 text-red-800 rounded text-sm hover:bg-red-200">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayReceipts(receipts) {
            const container = document.getElementById('receipts-container');
            
            if (receipts.length === 0) {
                container.innerHTML = `
                    <div class="bg-white border rounded-lg p-6 text-center">
                        <p class="text-slate-500">No execution receipts found.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = receipts.map(receipt => renderReceipt(receipt)).join('');
        }

        function renderReceipt(receipt) {
            const data = receipt.receipt_data;
            const hasReceiptData = data && typeof data === 'object';
            
            // Helper functions
            const formatDuration = (nanoseconds) => {
                if (!nanoseconds) return 'N/A';
                const seconds = nanoseconds / 1000000000;
                return `${seconds.toFixed(2)}s`;
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                try {
                    return new Date(dateStr).toLocaleString();
                } catch {
                    return dateStr;
                }
            };

            const getStatusColor = (status) => {
                switch (status?.toLowerCase()) {
                    case 'completed': case 'success': return 'bg-green-100 text-green-700';
                    case 'failed': case 'error': return 'bg-red-100 text-red-700';
                    case 'pending': case 'running': return 'bg-amber-100 text-amber-700';
                    default: return 'bg-slate-100 text-slate-700';
                }
            };

            const truncateMiddle = (str, maxLength = 40) => {
                if (!str || str.length <= maxLength) return str || 'N/A';
                const start = Math.floor(maxLength / 2) - 2;
                const end = Math.floor(maxLength / 2) - 2;
                return `${str.slice(0, start)}...${str.slice(-end)}`;
            };

            return `
                <div class="bg-white border rounded-lg overflow-hidden">
                    <!-- Receipt Header -->
                    <div class="border-b bg-slate-50 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold text-slate-900">Execution ${receipt.id}</h3>
                                <p class="text-sm text-slate-600 mt-1">Job ID: ${receipt.job_id || 'N/A'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(receipt.status)}">
                                ${(receipt.status || 'unknown').toUpperCase()}
                            </span>
                        </div>
                    </div>

                    <div class="p-6 space-y-6">
                        ${hasReceiptData ? `
                            <!-- AI Output Section -->
                            <div class="space-y-3">
                                <h4 class="font-medium text-slate-900 flex items-center gap-2">
                                    <span class="text-blue-500">🤖</span>
                                    AI Response Output
                                </h4>
                                
                                ${data.output?.data?.responses && Array.isArray(data.output.data.responses) ? `
                                    <!-- Multiple Question-Answer Format -->
                                    <div class="space-y-4">
                                        ${data.output.data.responses.map((response, index) => `
                                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                <div class="text-sm text-blue-900 font-medium mb-2">
                                                    Question ${index + 1}: ${response.question_id || `Q${index + 1}`}
                                                </div>
                                                <div class="text-xs text-slate-600 mb-2 italic">
                                                    "${response.question || 'Question text not available'}"
                                                </div>
                                                <div class="text-blue-800 bg-white rounded p-3 border">
                                                    "${response.response || 'No response available'}"
                                                </div>
                                                <div class="flex justify-between mt-2 text-xs text-slate-600">
                                                    <span>Category: ${response.category || 'N/A'}</span>
                                                    <span>Time: ${response.inference_time ? `${response.inference_time.toFixed(2)}s` : 'N/A'}</span>
                                                    <span class="${response.success ? 'text-green-600' : 'text-red-600'}">
                                                        ${response.success ? '✓ Success' : '✗ Failed'}
                                                    </span>
                                                </div>
                                                ${response.error ? `
                                                    <div class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                                                        Error: ${response.error}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                        
                                        ${data.output.data.summary ? `
                                            <div class="bg-slate-50 border rounded-lg p-4">
                                                <div class="text-sm font-medium text-slate-900 mb-2">Benchmark Summary</div>
                                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Total Questions:</span>
                                                        <span class="font-mono">${data.output.data.summary.total_questions || 0}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Successful:</span>
                                                        <span class="font-mono text-green-600">${data.output.data.summary.successful_responses || 0}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Failed:</span>
                                                        <span class="font-mono text-red-600">${data.output.data.summary.failed_responses || 0}</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-slate-600">Total Time:</span>
                                                        <span class="font-mono">${data.output.data.summary.total_inference_time ? `${data.output.data.summary.total_inference_time.toFixed(2)}s` : 'N/A'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <!-- Single Output Format (Fallback) -->
                                    <div class="space-y-3">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <div class="text-sm text-blue-900 font-medium mb-2">Generated Response:</div>
                                            <div class="text-blue-800 bg-white rounded p-3 border">
                                                "${data.output?.data?.text_output || data.output?.stdout || 'No output available'}"
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">Tokens Generated:</span>
                                                <span class="font-mono">${data.output?.data?.metadata?.tokens_generated || 'N/A'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">Execution Time:</span>
                                                <span class="font-mono">${data.output?.data?.metadata?.execution_time || 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                `}
                                <div class="text-xs">
                                    <span class="text-slate-600">Output Hash:</span>
                                    <code class="ml-2 bg-slate-100 px-2 py-1 rounded text-slate-800">${truncateMiddle(data.output?.hash)}</code>
                                </div>
                            </div>

                            <!-- Execution Details -->
                            <div class="space-y-3">
                                <h4 class="font-medium text-slate-900 flex items-center gap-2">
                                    <span class="text-green-500">🌍</span>
                                    Execution Details
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Task ID:</span>
                                            <code class="font-mono text-slate-800">${truncateMiddle(data.execution_details?.task_id)}</code>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Region:</span>
                                            <span class="font-semibold text-beacon-600">${data.execution_details?.region || receipt.region || 'N/A'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Provider ID:</span>
                                            <code class="font-mono text-slate-800">${truncateMiddle(data.execution_details?.provider_id)}</code>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Duration:</span>
                                            <span class="font-mono">${formatDuration(data.execution_details?.duration)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Started:</span>
                                            <span class="text-xs">${formatDate(data.execution_details?.started_at || receipt.started_at)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-600">Completed:</span>
                                            <span class="text-xs">${formatDate(data.execution_details?.completed_at)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Provider Information -->
                            ${data.provenance?.provider_info ? `
                            <div class="space-y-3">
                                <h4 class="font-medium text-slate-900 flex items-center gap-2">
                                    <span class="text-purple-500">🏢</span>
                                    Provider Information
                                </h4>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">Name:</span>
                                                <span class="font-medium">${data.provenance.provider_info.name || 'N/A'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">Score:</span>
                                                <span class="font-mono">${data.provenance.provider_info.score || 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">CPU:</span>
                                                <span class="font-mono">${data.provenance.provider_info.resources?.cpu || 'N/A'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-slate-600">Memory:</span>
                                                <span class="font-mono">${data.provenance.provider_info.resources?.memory || 'N/A'}MB</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Cryptographic Verification -->
                            <div class="space-y-3">
                                <h4 class="font-medium text-slate-900 flex items-center gap-2">
                                    <span class="text-amber-500">🔐</span>
                                    Cryptographic Verification
                                </h4>
                                <div class="space-y-3">
                                    <div class="text-sm">
                                        <span class="text-slate-600">JobSpec ID:</span>
                                        <code class="ml-2 bg-slate-100 px-2 py-1 rounded text-slate-800">${truncateMiddle(data.jobspec_id)}</code>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-slate-600">Public Key:</span>
                                        <code class="ml-2 bg-slate-100 px-2 py-1 rounded text-slate-800">${truncateMiddle(data.public_key)}</code>
                                    </div>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                        <div class="text-sm font-medium text-green-800 mb-2">Digital Signature:</div>
                                        <code class="text-xs text-green-700 break-all">${data.signature}</code>
                                    </div>
                                    ${data.provenance?.benchmark_hash ? `
                                    <div class="text-sm">
                                        <span class="text-slate-600">Benchmark Hash:</span>
                                        <code class="ml-2 bg-slate-100 px-2 py-1 rounded text-slate-800">${truncateMiddle(data.provenance.benchmark_hash)}</code>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : `
                            <!-- No Receipt Data Available -->
                            <div class="text-center py-8">
                                <div class="text-slate-400 mb-2">📄</div>
                                <p class="text-slate-500">Receipt data not available for this execution</p>
                                <div class="mt-4 text-sm text-slate-600">
                                    <div>Execution ID: <code class="bg-slate-100 px-2 py-1 rounded">${receipt.id}</code></div>
                                    <div class="mt-1">Started: ${formatDate(receipt.started_at)}</div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function loadSpecificReceipt() {
            const executionId = prompt('Enter Execution ID:');
            if (!executionId) return;
            
            const container = document.getElementById('receipts-container');
            container.innerHTML = `
                <div class="bg-white border rounded-lg p-6 text-center">
                    <div class="animate-spin inline-block w-6 h-6 border-2 border-beacon-600 border-t-transparent rounded-full"></div>
                    <p class="mt-2 text-slate-600">Loading execution ${executionId}...</p>
                </div>
            `;

            fetch(`${RUNNER_API}/api/v1/executions/${executionId}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Execution not found: ${response.status}`);
                    return response.json();
                })
                .then(async (execution) => {
                    try {
                        const receiptResponse = await fetch(`${RUNNER_API}/api/v1/executions/${execution.id}/receipt`);
                        if (receiptResponse.ok) {
                            const receiptData = await receiptResponse.json();
                            execution.receipt_data = receiptData;
                        }
                    } catch (e) {
                        console.warn(`Failed to load receipt for execution ${execution.id}:`, e);
                    }
                    displayReceipts([execution]);
                })
                .catch(error => {
                    container.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 text-red-800">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">Error loading execution</span>
                            </div>
                            <p class="mt-1 text-red-700 text-sm">${error.message}</p>
                        </div>
                    `;
                });
        }

        // Auto-load on page load
        window.onload = () => {
            loadLatestReceipts();
        };
    </script>
</body>
</html>
