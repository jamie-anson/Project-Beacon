name: Pull Request Tests

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq
        
    - name: Run smoke tests
      id: smoke
      run: |
        echo "ğŸ” Running smoke tests on PR changes..."
        chmod +x tests/integration/quick-smoke-test.sh
        ./tests/integration/quick-smoke-test.sh
        
    - name: Run health checks
      id: health
      run: |
        echo "ğŸ” Running health monitoring tests..."
        chmod +x tests/monitoring/health-check-tests.sh
        ./tests/monitoring/health-check-tests.sh
        
    - name: Validate test scripts
      run: |
        echo "ğŸ” Validating test script syntax..."
        
        # Check all shell scripts for syntax errors
        find tests/ -name "*.sh" -type f | while read -r script; do
          if ! bash -n "$script"; then
            echo "âŒ Syntax error in $script"
            exit 1
          else
            echo "âœ… $script syntax OK"
          fi
        done
        
    - name: Comment PR results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const smokeResult = '${{ steps.smoke.outcome }}';
          const healthResult = '${{ steps.health.outcome }}';
          
          let status = 'âœ… All tests passed';
          let details = '';
          
          if (smokeResult !== 'success' || healthResult !== 'success') {
            status = 'âŒ Some tests failed';
            details = `
            **Test Results:**
            - Smoke Tests: ${smokeResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
            - Health Checks: ${healthResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
            `;
          }
          
          const comment = `## ğŸ§ª PR Test Results
          
          ${status}
          
          ${details}
          
          **View Details:** [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ---
          *Automated testing by GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
